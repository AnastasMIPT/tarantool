-- test-run result file version 2
--
-- gh-6036: .
--
test_run = require('test_run').new()
 | ---
 | ...

test_run:cmd('create server master with script="replication/gh-6036-master.lua"')
 | ---
 | - true
 | ...
test_run:cmd('create server replica with script="replication/gh-6036-replica.lua"')
 | ---
 | - true
 | ...

test_run:cmd('start server master')
 | ---
 | - true
 | ...
test_run:cmd('start server replica')
 | ---
 | - true
 | ...

--
-- Connect master to the replica and write a record. Since the quorum
-- value is bigger than number of nodes in a cluster it will be rolled
-- back later.
test_run:switch('master')
 | ---
 | - true
 | ...
box.cfg({                                       \
    replication = {                             \
            "unix/:./master.sock",              \
            "unix/:./replica.sock",             \
    },                                          \
})
 | ---
 | ...
_ = box.schema.create_space('sync', {is_sync = true})
 | ---
 | ...
_ = box.space.sync:create_index('pk')
 | ---
 | ...

--
-- Wait the record to appear on the master.
f = require('fiber').create(function() box.space.sync:replace{1} end)
 | ---
 | ...
test_run:wait_cond(function() return box.space.sync:get({1}) ~= nil end, 100)
 | ---
 | - true
 | ...
box.space.sync:select{}
 | ---
 | - - [1]
 | ...

--
-- Wait the record from master get written and then
-- drop the replication.
test_run:switch('replica')
 | ---
 | - true
 | ...
test_run:wait_cond(function() return box.space.sync:get({1}) ~= nil end, 100)
 | ---
 | - true
 | ...
box.space.sync:select{}
 | ---
 | - - [1]
 | ...
box.cfg{replication = {}}
 | ---
 | ...

--
-- Then we jump back to the master and drop the replication,
-- thus unconfirmed record get rolled back.
test_run:switch('master')
 | ---
 | - true
 | ...
box.cfg({                                       \
    replication = {},                           \
    replication_synchro_timeout = 0.001,        \
    election_mode = 'manual',                   \
})
 | ---
 | ...
while f:status() ~= 'dead' do require('fiber').sleep(0.1) end
 | ---
 | ...
test_run:wait_cond(function() return box.space.sync:get({1}) == nil end, 100)
 | ---
 | - true
 | ...

--
-- Force the replica to become a RAFT leader.
test_run:switch('replica')
 | ---
 | - true
 | ...
box.cfg({                                       \
    replication_synchro_quorum = 1,             \
    election_mode = 'manual'                    \
})
 | ---
 | ...
box.ctl.promote()
 | ---
 | ...
box.space.sync:select{}
 | ---
 | - - [1]
 | ...

--
-- Connect master back to the replica.
test_run:switch('master')
 | ---
 | - true
 | ...
box.cfg({                                       \
    replication = {                             \
            "unix/:./replica.sock",             \
    },                                          \
})
 | ---
 | ...
box.space.sync:select{}
 | ---
 | - []
 | ...

--
-- Connect replica back to the master.
test_run:switch('replica')
 | ---
 | - true
 | ...
box.cfg({                                       \
    replication = {                             \
            "unix/:./master.sock",              \
    },                                          \
})
 | ---
 | ...
box.space.sync:select{}
 | ---
 | - - [1]
 | ...

test_run:switch('default')
 | ---
 | - true
 | ...
test_run:cmd('stop server master')
 | ---
 | - true
 | ...
--test_run:cmd('delete server master')
test_run:cmd('stop server replica')
 | ---
 | - true
 | ...
--test_run:cmd('delete server replica')
